#!/usr/bin/perl

use common::sense;

use FindBin;
#use local::lib '/servers';
use lib '/servers/sites/exocortex.nunonunes.org/lib/perl5',
  "$FindBin::Bin/../lib/perl5";

use Exocortex::Collector::Server;
use Exocortex::Log;
use Getopt::Long;
use YAML::AppConfig;
use Data::Dumper;

#TODO: Use Pod::Usage for the "usage" of the binary (with Getopt)

my $DEBUG = $ENV{DEBUG} || 0;
my $config_file = "$FindBin::Bin/../etc/exocortex-collectors-server.cfg";

my $result = GetOptions(
    "debug=i"       => \$DEBUG,
    "config_file=s" => \$config_file,
);

my $logger = Exocortex::Log->new( DEBUG => $DEBUG );
$logger->log( 0, "$0: Booting up with debug level $DEBUG" );

$logger->log( 1, "$0: Going to read configuration from \"$config_file\"" );

my $config = YAML::AppConfig->new( file => $config_file )
  || die "$0: Could not read config file: $!\n";

$logger->log( 2,
    "$0: Configuration read from file:\n" . Dumper $config->config );

my $collector_server = Exocortex::Collector::Server->new(
    DEBUG                 => $DEBUG,
    stats_report_interval => $config->get('stats_report_interval'),
    instance              => $config->get('instance'),

    # C&C via command line
    cli_port => $config->get('cli_port'),
    cli_host => $config->get('cli_host'),

    # Messaging stuff
    messaging_service => $config->get('messaging_service'),

    # Collectors to instantiate
    collectors => $config->get('collectors'),
);

$logger->log( 1, "$0: Launching server" );
$collector_server->start;
